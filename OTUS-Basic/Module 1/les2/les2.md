**Тема 2. Основы архитектуры компьютера: память и потоки**

**Цель занятия:**

* Понять, как устроена память в компьютере и как она используется в программах.
* Разобраться в разнице между стеком и кучей.
* Изучить основы многопоточности и связанные с ней издержки.

---

**1. Области памяти программы**

Программа во время выполнения использует несколько разных областей памяти:

* **Стек (stack)**

  * Быстрая память с жёстким порядком (LIFO — last in, first out).
  * Хранит локальные переменные, параметры функций, указатели возврата.
  * Автоматическое управление памятью — переменные уничтожаются при выходе из области видимости.
  * Ограничен по размеру (обычно несколько мегабайт).

* **Куча (heap)**

  * Гибкое хранилище для данных, которые живут дольше, чем область функции.
  * Используется для хранения больших объектов или объектов, чьё время жизни не известно заранее.
  * Требует явного управления (в Rust через владение и `Box`, `Rc`, `Arc` и т.п.).
  * Более медленная, чем стек, из-за необходимости управления временем жизни.

* **Статическая память**

  * Переменные, объявленные как `static` или `const`, хранятся в отдельной области памяти.
  * Живут всё время работы программы.

---

**2. Архитектура процессора (введение)**

* **Процессор (CPU)** выполняет инструкции программы и взаимодействует с памятью.
* **Регистр** — самый быстрый вид памяти, встроенный в сам процессор.
* **Шина (bus)** — канал передачи данных между процессором и памятью/устройствами.
* **Кэш** — промежуточная память между регистрами и оперативной памятью (L1, L2, L3).
* **ОЗУ (RAM)** — основная рабочая память, куда загружаются программы.

---

**3. Виртуальная и физическая память**

* **Физическая память** — это настоящая оперативная память (RAM).
* **Виртуальная память** — абстракция, предоставляемая операционной системой.
  Программа думает, что работает с непрерывным пространством памяти, хотя фактически она может быть разбросана по физической памяти.

Преимущества виртуальной памяти:

* Изоляция между процессами.
* Возможность использовать больше памяти, чем физически установлено (через подкачку).
* Простота управления памятью для разработчика.

---

**4. Потоки (threads)**

* **Поток (thread)** — единица выполнения в процессе. Один процесс может содержать несколько потоков, которые выполняются параллельно.
* Потоки **делят память** процесса (особенно кучу), но имеют собственный стек.

**Проблемы многопоточности:**

* **Гонки данных (data races):** когда два потока одновременно читают и записывают в одну и ту же память.
* **Взаимные блокировки (deadlocks):** потоки ждут друг друга бесконечно.
* **Непредсказуемое поведение:** порядок выполнения потоков может быть разным при каждом запуске.

**Решения в Rust:**

* Безопасность многопоточности встроена в язык через систему типов и трейты `Send` и `Sync`.
* Rust **не позволит скомпилировать** программу, если доступ к разделяемым данным потенциально опасен.

---

**5. Выводы**

* Понимание устройства памяти помогает писать эффективный и безопасный код.
* В Rust нельзя абстрагироваться от архитектуры компьютера — язык делает её частью модели безопасности.
* Работа с памятью и многопоточностью в Rust требует дисциплины, но это снижает количество ошибок.

---

**Рекомендуемые источники:**

* Статья в The Book: *The Stack and the Heap*
  [https://doc.rust-lang.org/book/ch04-01-what-is-ownership.html](https://doc.rust-lang.ru/book/ch04-01-what-is-ownership.html)
* Введение в архитектуру компьютера:
  [https://en.wikipedia.org/wiki/Computer\_architecture](https://en.wikipedia.ru/wiki/Computer_architecture)
* Rust и многопоточность:
  [https://doc.rust-lang.org/book/ch16-00-concurrency.html](https://doc.rust-lang.ru/book/ch16-00-concurrency.html)